import json
from financial_report.utils.chat import chat_no_tool
from financial_report.utils.extract_json_array import extract_json_array

generate_macro_outline_system_content = """你是一位顶级的专业宏观经济分析师。你的任务是为给定的宏观主题，生成一份结构清晰、内容专业的宏观经济/策略研究报告大纲。"""

generate_macro_outline_user_prompt = """请你按照要求帮我生成一份宏观经济/策略研报的大纲，为后续的写作提供框架和思路。

**核心要求：**
1.  **内容框架**: 大纲需全面覆盖宏观经济核心指标、政策解读、联动分析、全球视野、风险预警等维度。
    * 应能自动抽取与呈现宏观经济核心指标（GDP、CPI、利率、汇率等）的分析框架。
    * 应包含对政策报告与关键口径进行解读的分析方法。
    * 应构建政策联动与区域对比分析模型，解释宏观变量间的交互影响（如降准对出口与CPI的传导路径）。
    * 应支持全球视野的模拟建模（如美联储利率变动对全球资本流动的影响）。
    * 应提供对潜在"灰犀牛"事件的风险预警机制与指标设计。
    * 应包含政策效果评估的量化分析框架与跟踪机制。

2.  **内容形式**: 大纲的要点(points)应该是**需要分析的主题或问题**，用于指导写作方向。**请不要在要点中直接填写具体的数据、分析结论或示例性内容。**
    **错误示例 (不要这样做):**
    - "GDP增速为6.5%"
    - "政策效果显著，拉动经济增长2个百分点"

    **正确示例 (请这样做):**
    - "GDP增速变化趋势及其驱动因素分析"
    - "政策实施效果的量化评估与传导机制分析"

3.  **输出格式**: 必须严格按照JSON格式输出。禁止在JSON代码块前后添加任何多余的解释、注释或文字。
    **输出格式示例**:
    ```json
    {
        "macroTheme": "宏观：国家级"人工智能+"政策效果评估 (2023-2025)",
        "reportTitle": "宏观：国家级"人工智能+"政策效果评估报告 (2023-2025)",
        "reportOutline": [
            {
                "title": "一、研究摘要与核心观点",
                "points": [
                    "政策效果评估核心结论与量化成果",
                    "宏观经济传导机制的关键发现",
                    "政策实施的阶段性特征与演进趋势",
                    "主要风险点识别与政策建议",
                    "未来政策走向预判与市场影响展望"
                ]
            },
            {
                "title": "二、宏观经济环境与基础指标分析",
                "points": [
                    "核心宏观经济指标（GDP、CPI、PPI、PMI等）变化趋势分析",
                    "货币政策环境：利率、流动性、货币供应量指标解读",
                    "财政政策环境：财政收支、债务水平、税收结构分析",
                    "汇率与国际收支：人民币汇率走势及其对政策效果的影响",
                    "就业与收入分配：劳动力市场指标与收入结构变化"
                ]
            },
            {
                "title": "三、"人工智能+"政策框架梳理与解读",
                "points": [
                    "国家级AI+政策体系构建：顶层设计与实施路径",
                    "关键政策文件解读：政策目标、实施措施与时间节点",
                    "财政支持政策：资金投入规模、支持方式与资源配置",
                    "税收优惠政策：税收减免、研发费用加计扣除等政策工具",
                    "监管政策框架：数据安全、算法治理、伦理规范等配套措施"
                ]
            },
            {
                "title": "四、政策传导机制与宏观联动分析",
                "points": [
                    "AI+政策对GDP增长的直接与间接传导路径分析",
                    "政策实施对投资、消费、出口三驾马车的影响机制",
                    "产业结构升级：政策推动下的产业转型与价值链重构",
                    "就业结构变化：AI技术应用对劳动力市场的结构性影响",
                    "区域发展差异：政策在不同区域的实施效果与空间分布特征"
                ]
            },
            {
                "title": "五、量化评估模型与效果测度",
                "points": [
                    "政策效果评估指标体系构建与权重设计",
                    "反事实分析：政策实施前后的对比评估模型",
                    "多维度量化分析：经济效益、社会效益、创新效益测算",
                    "政策乘数效应测算：财政投入的经济拉动效应分析",
                    "成本效益分析：政策投入产出比与资源配置效率评估"
                ]
            },
            {
                "title": "六、国际比较与全球视野分析",
                "points": [
                    "主要经济体AI政策对比：美国、欧盟、日本等政策框架比较",
                    "全球AI竞争格局：中国政策在全球AI竞争中的地位与作用",
                    "国际资本流动影响：AI+政策对外资流入与对外投资的影响",
                    "贸易结构变化：AI技术发展对进出口贸易结构的影响分析",
                    "汇率传导效应：AI产业发展对人民币汇率的长期影响"
                ]
            },
            {
                "title": "七、区域差异与空间分布分析",
                "points": [
                    "政策实施的区域差异：东中西部地区政策效果对比分析",
                    "城市群发展模式：京津冀、长三角、粤港澳等重点区域分析",
                    "产业集群效应：AI产业园区与创新中心的空间布局优化",
                    "区域协调发展：政策推动下的区域平衡与协调机制",
                    "城乡发展差距：AI+政策对城乡发展不平衡的影响分析"
                ]
            },
            {
                "title": "八、风险识别与预警机制设计",
                "points": [
                    "政策实施风险识别：执行偏差、资源错配、道德风险等",
                    "宏观经济风险预警：通胀压力、资产泡沫、债务风险等",
                    "技术发展风险：AI技术发展的不确定性与潜在负面影响",
                    "社会稳定风险：就业结构调整、收入分配、数字鸿沟等社会问题",
                    ""灰犀牛"事件识别：系统性风险源与传导路径分析"
                ]
            },
            {
                "title": "九、政策优化建议与未来展望",
                "points": [
                    "现有政策体系的优化方向：政策工具完善与实施机制改进",
                    "财政政策建议：支出结构优化与资金使用效率提升",
                    "货币政策协调：货币政策与AI+政策的协同配合机制",
                    "监管政策完善：适应AI发展的监管框架与治理体系建设",
                    "长期政策规划：2025年后AI+政策的演进方向与战略布局"
                ]
            },
            {
                "title": "十、情景分析与政策模拟",
                "points": [
                    "基准情景：当前政策延续下的宏观经济发展预测",
                    "乐观情景：政策效果超预期下的经济增长潜力分析",
                    "悲观情景：政策实施受阻或外部冲击下的风险应对",
                    "敏感性分析：关键变量变化对政策效果的影响测试",
                    "政策调整模拟：不同政策组合下的宏观经济影响预测"
                ]
            }
        ]
    }
    ```

我需要生成的研报的宏观主题是：
"""


def generate_macro_outline(
    macro_theme,
    api_key: str = None,
    base_url: str = None,
    model: str = None,
    max_tokens: int = 4000,
    temperature: float = 0.5,
):
    """
    使用指定的提示词生成宏观经济/策略研报大纲。
    """

    user_content = generate_macro_outline_user_prompt + macro_theme
    outline = chat_no_tool(
        user_content=generate_macro_outline_system_content + user_content,
        api_key=api_key,
        base_url=base_url,
        model=model,
        temperature=temperature,
        max_tokens=max_tokens,
    )
    return json.loads(extract_json_array(outline))
