import json
from financial_report.utils.chat import chat_no_tool
from financial_report.utils.extract_json_array import extract_json_array

generate_industry_outline_system_content = """你是一位顶级的专业金融分析师。你的任务是为给定的目标行业，生成一份结构清晰、内容专业的深度研究报告大纲。"""

generate_industry_outline_user_prompt = """请你按照要求帮我生成一份行业研报的大纲，为后续的写作提供框架和思路。
**核心要求：**
1.  **内容框架**: 大纲需全面覆盖宏观环境、产业链、市场格局、发展趋势、投资策略及风险等维度。
    * 应能聚合行业发展相关数据（协会年报、企业财报等），输出行业生命周期与结构解读。
    * 应包含行业集中度、产业链上下游分析、市场集中度（CRn）、波特五力等结构性分析。
    * 应融合趋势分析与外部变量预测能力（如政策影响、技术演进）。
    * 应支持对未来3-5年的行业规模进行情景模拟与预测。
    * 应提供行业进入与退出策略建议，支持关键变量（如上游原材料价格）敏感性分析。
    * 应说明行业规模变动、竞争格局等核心要素。

2.  **内容形式**: 大纲的要点(points)应该是**需要分析的主题或问题**，用于指导写作方向。**请不要在要点中直接填写具体的数据、分析结论或示例性内容。**
    **错误示例 (不要这样做):**
    - "市场规模预测：2025年将达到5000亿"
    - "行业CR5=60% (2023年)"

    **正确示例 (请这样做):**
    - "未来三至五年行业市场规模及增速预测"
    - "行业集中度与核心玩家市场份额分析"

3.  **输出格式**: 必须严格按照JSON格式输出。禁止在JSON代码块前后添加任何多余的解释、注释或文字。
    **输出格式示例**:
    ```json
    {
        "industryName": "中国智能服务机器人产业",
        "reportTitle": "中国智能服务机器人产业深度研究报告",
        "reportOutline": [
            {
                "title": "一、投资摘要与核心观点",
                "points": [
                    "核心投资逻辑：技术驱动与需求扩张下的行业高景气度分析",
                    "行业发展阶段与市场空间判断",
                    "主要投资机遇与细分赛道梳理",
                    "行业评级与未来展望",
                    "主要风险提示"
                ]
            },
            {
                "title": "二、宏观环境与政策背景",
                "points": [
                    "全球及中国宏观经济环境对行业发展的影响分析",
                    "国家产业政策及相关扶持政策解读",
                    "技术发展趋势与政策导向分析",
                    "国际贸易环境与地缘政治对行业的影响"
                ]
            },
            {
                "title": "三、行业概览与生命周期分析",
                "points": [
                    "行业定义、范畴与细分市场结构分析",
                    "行业发展历程与关键里程碑事件回顾",
                    "行业生命周期阶段判断（导入期、成长期、成熟期、衰退期）",
                    "行业规模测算：历史数据、现状分析与增长驱动因素"
                ]
            },
            {
                "title": "四、产业链与价值链深度剖析",
                "points": [
                    "产业链全景图：上游供应商、中游制造商、下游应用市场",
                    "上游供应链分析：关键原材料、核心零部件、供应商议价能力",
                    "中游制造环节：生产工艺、技术壁垒、成本结构分析",
                    "下游应用市场：需求特征、客户结构、渗透率分析",
                    "价值链利润分布与各环节附加值分析"
                ]
            },
            {
                "title": "五、市场格局与竞争态势分析",
                "points": [
                    "行业市场规模与增长趋势分析",
                    "市场集中度分析：CR4、CR8、HHI指数等集中度指标",
                    "竞争格局分析：头部企业、第二梯队、长尾企业分布",
                    "波特五力模型分析：供应商议价能力、购买者议价能力、潜在进入者威胁、替代品威胁、现有竞争者竞争",
                    "核心竞争要素识别：技术壁垒、品牌影响力、渠道优势、成本控制"
                ]
            },
            {
                "title": "六、发展趋势与前沿技术演进",
                "points": [
                    "技术发展趋势与创新方向分析",
                    "新兴技术对行业变革的影响评估",
                    "商业模式创新与数字化转型趋势",
                    "消费者需求变化与市场机遇识别",
                    "国际市场发展趋势与全球化机遇"
                ]
            },
            {
                "title": "七、情景分析与预测模型",
                "points": [
                    "基准情景下的行业发展预测（未来3-5年）",
                    "乐观情景：高增长驱动因素与市场空间测算",
                    "悲观情景：下行风险与市场收缩可能性分析",
                    "关键变量敏感性分析：原材料价格、政策变化、技术突破等",
                    "行业拐点识别与时间窗口预测"
                ]
            },
            {
                "title": "八、投资策略与进入退出分析",
                "points": [
                    "行业整体投资价值评估与投资逻辑",
                    "细分赛道投资机会排序与优先级分析",
                    "行业进入策略：进入壁垒、最佳时机、成功要素",
                    "退出策略：退出信号、退出方式、价值实现路径",
                    "投资风险评估与风险管理建议"
                ]
            },
            {
                "title": "九、风险因素与应对策略",
                "points": [
                    "政策监管风险：政策变化对行业发展的影响",
                    "技术迭代风险：技术突破对现有格局的冲击",
                    "市场竞争风险：新进入者与替代品威胁",
                    "宏观经济风险：经济周期对行业需求的影响",
                    "供应链风险：关键原材料价格波动与供应安全"
                ]
            }
        ]
    }
    ```
我需要生成的研报的目标行业是：
"""


def generate_industry_outline(
    industry,
    api_key: str = None,
    base_url: str = None,
    model: str = None,
    max_tokens: int = 4000,
    temperature: float = 0.5,
):
    """
    使用指定的提示词生成行业研报大纲。
    """

    user_content = generate_industry_outline_user_prompt + industry
    outline = chat_no_tool(
        user_content=generate_industry_outline_system_content + user_content,
        api_key=api_key,
        base_url=base_url,
        model=model,
        temperature=temperature,
        max_tokens=max_tokens,
    )
    return json.loads(extract_json_array(outline))
